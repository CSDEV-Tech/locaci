# syntax = docker/dockerfile:1.3
FROM node:16-slim

RUN apt-get update
RUN apt-get install -y openssl

WORKDIR /app
# Env from args 
ARG NEXT_PUBLIC_MAPBOX_KEY
ARG NEXT_PUBLIC_OAUTH_CLIENT_ID
ARG NEXT_PUBLIC_OAUTH_ISSUER_BASE_URL

ENV NEXT_PUBLIC_MAPBOX_KEY=$NEXT_PUBLIC_MAPBOX_KEY
ENV NEXT_PUBLIC_OAUTH_CLIENT_ID=$NEXT_PUBLIC_OAUTH_CLIENT_ID
ENV NEXT_PUBLIC_OAUTH_ISSUER_BASE_URL=$NEXT_PUBLIC_OAUTH_ISSUER_BASE_URL

# Install pnpm 
RUN npm install -g pnpm@7.1

# Install packages
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./tailwind.config.js ./tsconfig.json /app
COPY ui/package.json /app/ui/package.json
COPY web/package.json /app/web/package.json

RUN pnpm install --shamefully-hoist --strict-peer-dependencies=false --frozen-lockfile --ignore-scripts=true --filter=web...

COPY ./web /app/web
COPY ./ui /app/ui

# Disable telemetry
RUN pnpm run --filter=web telemetry:disable 

# Run build with secrets
RUN --mount=type=secret,id=_env,dst=/app/web/.env FORCE_COLOR=true pnpm run --filter=web prepare-db \
  && FORCE_COLOR=true pnpm run --filter=web... build

COPY ./docker-start.sh /app
RUN chmod a+x /app/docker-start.sh

CMD ["/bin/sh", "-c", "/app/docker-start.sh"]
